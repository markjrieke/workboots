<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="workboots">
<title>The Math Behind workboots • workboots</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The Math Behind workboots">
<meta property="og:description" content="workboots">
<meta property="og:image" content="https://markjrieke.github.io/workboots/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">workboots</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Estimating-Linear-Intervals.html">Estimating Linear Intervals</a>
    <a class="dropdown-item" href="../articles/Getting-Started-with-workboots.html">Getting Started with workboots</a>
    <a class="dropdown-item" href="../articles/The-Math-Behind-workboots.html">The Math Behind workboots</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/markjrieke/workboots/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="The-Math-Behind-workboots_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>The Math Behind workboots</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/markjrieke/workboots/blob/HEAD/vignettes/The-Math-Behind-workboots.Rmd" class="external-link"><code>vignettes/The-Math-Behind-workboots.Rmd</code></a></small>
      <div class="d-none name"><code>The-Math-Behind-workboots.Rmd</code></div>
    </div>

    
    
<p>Generating prediction intervals with workboots hinges on a few core concepts: bootstrap resampling, estimating prediction error for each resample, and aggregating the resampled prediction errors for each observation. The <a href="https://rsample.tidymodels.org/reference/bootstraps.html" class="external-link"><code>bootstraps()</code> documentation from {rsample}</a> gives a concise definition of bootstrap resampling:</p>
<blockquote>
<p>A bootstrap sample is a sample that is the same size as the original data set that is made using replacement. This results in analysis samples that have multiple replicates of some of the original rows of the data. The assessment set is defined as the rows of the original data that were not included in the bootstrap sample. This is often referred to as the “out-of-bag” (OOB) sample.</p>
</blockquote>
<p>This vignette will walk through the details of estimating and aggregating prediction errors — additional resources can be found in Davison and Hinkley’s book, <a href="https://www.cambridge.org/core/books/bootstrap-methods-and-their-application/ED2FD043579F27952363566DC09CBD6A" class="external-link"><em>Bootstrap Methods and their Application</em></a>, or Efron and Tibshirani’s paper, <a href="https://www.jstor.org/stable/2965703" class="external-link"><em>Improvements on Cross-Validation: The Bootstrap .632+ Method</em></a>.</p>
<div class="section level3">
<h3 id="the-bootstrap--632-method">The Bootstrap .632+ Method<a class="anchor" aria-label="anchor" href="#the-bootstrap--632-method"></a>
</h3>
<p><em>What follows here is largely a summary of <a href="https://stats.stackexchange.com/questions/96739/what-is-the-632-rule-in-bootstrapping/96750#96750" class="external-link">this explanation</a> of the .632+ error rate by Benjamin Deonovic.</em></p>
<p>When working with bootstrap resamples of a dataset, there are two error estimates we can work with: the bootstrap training error and the out-of-bag (oob) error. Using the <a href="https://modeldata.tidymodels.org/reference/Sacramento.html" class="external-link">Sacramento housing dataset</a>, we can estimate the training and oob error for a single bootstrap.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sacramento_boots</span></span>
<span><span class="co">#&gt; # Bootstrap sampling </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   splits            id        </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="color: #949494;">&lt;split [699/261]&gt;</span> Bootstrap1</span></span></code></pre></div>
<p>Using a <a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm#k-NN_regression" class="external-link">k-nearest-neighbor regression model</a> and <a href="https://en.wikipedia.org/wiki/Root-mean-square_deviation#:~:text=The%20root%2Dmean%2Dsquare%20deviation,estimator%20and%20the%20values%20observed." class="external-link">rmse</a> as our error metric, we find that the training and oob error differ, with the training error lesser than the oob error.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sacramento_train_err</span></span>
<span><span class="co">#&gt; [1] 0.08979873</span></span>
<span><span class="va">sacramento_oob_err</span></span>
<span><span class="co">#&gt; [1] 0.1661675</span></span></code></pre></div>
<p>The training error is overly optimistic in the model’s performance and likely to under-estimate the prediction error. We are interested in the model’s performance on new data. The oob error, on the other hand, is likely to over-estimate the prediction error! This is due to non-distinct observations in the bootstrap sample that results from sampling with replacement. Given that <a href="https://stats.stackexchange.com/questions/88980/why-on-average-does-each-bootstrap-sample-contain-roughly-two-thirds-of-observat?lq=1" class="external-link">the average number of distinct observations in a bootstrap training set is about <code>0.632 * total_observations</code></a>, Efron and Tibshirani proposed a blend of the training and oob error with the 0.632 estimate:</p>
<p><span class="math display">\[\begin{align*}
Err_{.632} &amp; = 0.368 Err_{train} + 0.632 Err_{oob}
\end{align*}\]</span></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sacramento_632</span> <span class="op">&lt;-</span> <span class="fl">0.368</span> <span class="op">*</span> <span class="va">sacramento_train_err</span> <span class="op">+</span> <span class="fl">0.632</span> <span class="op">*</span> <span class="va">sacramento_oob_err</span></span>
<span><span class="va">sacramento_632</span></span>
<span><span class="co">#&gt; [1] 0.1380638</span></span></code></pre></div>
<p>If, however, the model is highly overfit to the bootstrap training set, the training error will approach 0 and the 0.632 estimate will <em>under estimate</em> the prediction error.</p>
<p>An example from <a href="http://appliedpredictivemodeling.com/" class="external-link"><em>Applied Predictive Modeling</em></a> shows that as model complexity increases, the reported resample accuracy by the 0.632 estimate continues to increase whereas other resampling strategies report diminishing returns:</p>
<p><img src="https://user-images.githubusercontent.com/5731043/157986232-9c32c1c2-a7ed-4f9f-b28e-7d8ccb7ac41c.png"></p>
<p>As an alternative to the 0.632 estimate, Efron &amp; Tibshirani also propose the 0.632+ estimate, which re-weights the blend of training and oob error based on the model overfit rate:</p>
<p><span class="math display">\[\begin{align*}
Err_{0.632+} &amp; = (1 - w) Err_{train} + w Err_{oob} \\
\\
w &amp; = \frac{0.632}{1 - 0.368 R} \\
\\
R &amp; = \frac{Err_{oob} - Err_{train}}{\gamma - Err_{train}}
\end{align*}\]</span></p>
<p>Here, <span class="math inline">\(R\)</span> represents the overfit rate and <span class="math inline">\(\gamma\)</span> is the no-information error rate, estimated by evaulating all combinations of predictions and actual values in the bootstrap training set.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sacramento_632_plus</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">w</span><span class="op">)</span> <span class="op">*</span> <span class="va">sacramento_train_err</span> <span class="op">+</span> <span class="va">w</span> <span class="op">*</span> <span class="va">sacramento_oob_err</span></span>
<span><span class="va">sacramento_632_plus</span></span>
<span><span class="co">#&gt; [1] 0.1450502</span></span></code></pre></div>
<p>When there is no overfitting (i.e., <span class="math inline">\(R = 0\)</span>) the 0.632+ estimate will equal the 0.632 estimate. In this case, however, the model is overfitting the training set and the 0.632+ error estimate is pushed a bit closer to the oob error.</p>
</div>
<div class="section level3">
<h3 id="prediction-intervals-with-many-bootstraps">Prediction intervals with many bootstraps<a class="anchor" aria-label="anchor" href="#prediction-intervals-with-many-bootstraps"></a>
</h3>
<p><a href="https://en.wikipedia.org/wiki/Root-mean-square_deviation#Formula" class="external-link">For an unbiased estimator, rmse is the standard deviation of the residuals</a>. With this in mind, we can modify our predictions to include a sample from the residual distribution (for more information, see Algorithm 6.4 from Davison and Hinkley’s <em>Bootstrap Methods and their Application</em>):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">resid_train_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">preds_train</span><span class="op">)</span>, <span class="fl">0</span>, <span class="va">sacramento_632_plus</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preds_train_mod</span> <span class="op">&lt;-</span> <span class="va">preds_train</span> <span class="op">+</span> <span class="va">resid_train_add</span></span></code></pre></div>
<p>Thus far, we’ve been working with a single bootstrap resample. When working with a single bootstrap resample, adding this residual term gives a pretty poor estimate for each observation:</p>
<p><img src="The-Math-Behind-workboots_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>With workboots, however, we can repeat this process over many bootstrap datasets to generate a prediction distribution for each observation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/markjrieke/workboots" class="external-link">workboots</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit and predict price in sacramento_test from 100 models</span></span>
<span><span class="co"># the default number of resamples is 2000 - dropping here to speed up knitting</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">555</span><span class="op">)</span></span>
<span><span class="va">sacramento_pred_int</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">sacramento_wf</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="../reference/predict_boots.html">predict_boots</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    training_data <span class="op">=</span> <span class="va">sacramento_train</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">sacramento_test</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="The-Math-Behind-workboots_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p>This methodology produces prediction distributions that are <a href="https://markjrieke.github.io/workboots/articles/Estimating-Linear-Intervals.html">consistent with what we might expect from linear models</a> while making no assumptions about model type (i.e., we can use a non-parametric model; in this case, a k-nearest neighbors regression).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mark Rieke.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
